(function(){"use strict";class g{constructor(t,s=4){this.boundary=t,this.capacity=s,this.points=[],this.divided=!1}subdivide(){const{x:t,y:s,w:i,h:e}=this.boundary,c={x:t-i/2,y:s-e/2,w:i/2,h:e/2},n={x:t+i/2,y:s-e/2,w:i/2,h:e/2},l={x:t-i/2,y:s+e/2,w:i/2,h:e/2},h={x:t+i/2,y:s+e/2,w:i/2,h:e/2};this.northwest=new g(c,this.capacity),this.northeast=new g(n,this.capacity),this.southwest=new g(l,this.capacity),this.southeast=new g(h,this.capacity),this.divided=!0}insert(t){return this._contains(this.boundary,t)?this.points.length<this.capacity&&!this.divided?(this.points.push(t),!0):(this.divided||this.subdivide(),this.northwest.insert(t)||this.northeast.insert(t)||this.southwest.insert(t)||this.southeast.insert(t)):!1}query(t,s){if(!this._intersects(this.boundary,t))return s;for(let i of this.points)this._contains(t,i)&&s.push(i);return this.divided&&(this.northwest.query(t,s),this.northeast.query(t,s),this.southwest.query(t,s),this.southeast.query(t,s)),s}_contains(t,s){return s.x>=t.x-t.w&&s.x<=t.x+t.w&&s.y>=t.y-t.h&&s.y<=t.y+t.h}_intersects(t,s){return!(s.x-s.w>t.x+t.w||s.x+s.w<t.x-t.w||s.y-s.h>t.y+t.h||s.y+s.h<t.y-t.h)}}class ${constructor(){this.cache=new Map,this.lib={map:(t,s,i,e,c)=>(t-s)*(c-e)/(i-s)+e,oscillate:(t,s)=>Math.sin(t*s*Math.PI*2)*.5+.5,lerp:(t,s,i)=>t+(s-t)*i}}compile(t){if(this.cache.has(t))return this.cache.get(t);try{const i=t.replace(/^{{|}}$/g,"").trim().split("|").map(h=>h.trim()),e=i[0],c=i.slice(1),n=e.replace(/[^a-zA-Z0-9_.]/g,""),l=new Function("state","compiler",`
                "use strict";
                try {
                    let val = state["${n}"];
                    if (val === undefined) return 0;
                    ${this._buildFilterLogic(c)}
                    return val;
                } catch (e) {
                    return 0; // Fallback de Seguridad
                }
            `);return this.cache.set(t,l),l}catch(s){return console.warn("[ISK-WORKER] JIT Compilation error:",s),()=>0}}_buildFilterLogic(t){let s="";return t.forEach(i=>{const e=i.match(/^(\w+)\((.*)\)$/);if(e){const c=e[1],n=e[2];s+=`val = compiler.lib.${c}(val, ${n});
`}}),s}}const A=new $;let y=null,b=null,m=null,d=null,_=!0,F=new Map,k=!1;const I={SEMANTIC_GRAVITY:.05,REPULSION_FORCE:800,FRICTION:.92,TIME_STEP:1};self.onmessage=function(a){const{action:t,payload:s}=a.data;switch(t){case"INIT":y=s,Object.keys(s.laws).length;const i=s.textureSize*s.textureSize*4;b=new Float32Array(i),m=new Float32Array(i),d=new Float32Array(i);for(const[M,w]of Object.entries(y.laws)){w.id=M;const T=w.index*4,S=w.schemaId||"GENERIC";let x=1;S.includes("COSMOS")?x=5:S.includes("FOLDER")||S.includes("VAULT")?x=3:S.includes("EMAIL")&&(x=.8),d[T]=0,d[T+1]=0,d[T+2]=x,d[T+3]=.1/x;for(const r in w.executors){const u=w.executors[r];typeof u=="string"&&(w.executors[r]=A.compile(u))}}break;case"UPDATE_STATE":if(!y)return;const{state:e,sequenceId:c}=s,n=_?m:b;z(_?b:m,n,e),G(e,n),self.postMessage({action:"REIFICATION_RESULT",results:n,sequenceId:c},[n.buffer]),_?m=new Float32Array(n.length):b=new Float32Array(n.length),_=!_;break;case"HFS_UPDATE":if(!y)return;const{target_id:h,property:p,value:E}=s;H(h,p,E);break;case"SET_PANIC_MODE":k=s.enabled;break}};function z(a,t,s){(s.phenotype.artifacts||[]).forEach(r=>F.set(r.id,r));const e=Object.values(y.laws),c=e.length,n=[];let l=-1e3,h=1e3,p=-1e3,E=1e3;for(let r=0;r<c;r++){const u=e[r].index*4,o=a[u],f=a[u+1];o<l&&(l=o-100),o>h&&(h=o+100),f<p&&(p=f-100),f>E&&(E=f+100)}const M=(l+h)/2,w=(p+E)/2,T=(h-l)/2,S=(E-p)/2,x=new g({x:M,y:w,w:T,h:S},4);for(let r=0;r<c;r++){const u=e[r],o=u.index*4,f=F.get(u.id);f&&!f._isDeleted&&x.insert({x:a[o],y:a[o+1],off:o})}for(let r=0;r<c;r++){const u=e[r],o=u.index*4,f=F.get(u.id);if(f!=null&&f._isDeleted){t[o+3]=0,n.push(u.id);continue}let O=a[o],R=a[o+1],q=d[o+2]||1,C=d[o],v=d[o+1];const V=(s.centerX||0)-O,X=(s.centerY||0)-R;if(C+=V*I.SEMANTIC_GRAVITY/q,v+=X*I.SEMANTIC_GRAVITY/q,!k){const J={x:O,y:R,w:200,h:200},U=x.query(J);for(let N=0;N<U.length;N++){const D=U[N];if(D.off===o)continue;const L=O-D.x,P=R-D.y,Y=L*L+P*P+.1;if(Y<4e4){const j=I.REPULSION_FORCE/Y;C+=L*j,v+=P*j}}}C*=I.FRICTION,v*=I.FRICTION,d[o]=C,d[o+1]=v,u._isDragging?(t[o]=O,t[o+1]=R):(t[o]=O+C*I.TIME_STEP,t[o+1]=R+v*I.TIME_STEP)}n.forEach(r=>{delete y.laws[r],F.delete(r)})}function G(a,t){const s=Object.entries(y.laws);for(const[i,e]of s){const c=e.index*4,n=e.executors,l=F.get(i);if(l!=null&&l._isDeleted){t[c+3]=0;continue}try{if(!l||l._isDirty||e._isDragging||a.isLoading){n.x&&(t[c]=n.x(a,A)),n.y&&(t[c+1]=n.y(a,A)),t[c+2]=n.radius?n.radius(a,A):10;let h=n.u_visibility?n.u_visibility(a,A):1;a.isLoading&&(h=.5+Math.sin(Date.now()*.02)*.5),t[c+3]=h}}catch{t[c+3]=0}}}function H(a,t,s){const i=y.laws[a];if(!i)return;const e=i.index*4,c=_?b:m;switch(t){case"u_pos":Array.isArray(s)&&(c[e]=s[0],c[e+1]=s[1],d[e]=0,d[e+1]=0,i._isDragging=!0);break;case"u_drag_end":i._isDragging=!1;break;case"u_radius":c[e+2]=s;break;case"u_visibility":c[e+3]=s?1:0;break}const n=c.slice();self.postMessage({action:"REIFICATION_RESULT",results:n,isPartial:!0},[n.buffer])}})();
//# sourceMappingURL=SpatialWorker-B4jZiYSs.js.map
