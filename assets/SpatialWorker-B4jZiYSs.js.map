{"version":3,"file":"SpatialWorker-B4jZiYSs.js","sources":["../src/core/kernel/isk/SpatialWorker.js"],"sourcesContent":["/**\n * У ISK: SPATIAL WORKER (v3.2 - Hardened)\n * Thread-side Expression Engine & Real-Time Reification.\n * Features: Internal JIT, Double Buffering (Zero-Copy), Safety Fallbacks.\n * V10.9: QuadTree Spatial Partitioning ($O(n \\log n)$).\n */\n\n// --- QUAD_TREE SPATIAL PARTITIONING (v1.0) ---\nclass QuadTree {\n    constructor(boundary, capacity = 4) {\n        this.boundary = boundary; // {x, y, w, h} (Center + half-size)\n        this.capacity = capacity;\n        this.points = [];\n        this.divided = false;\n    }\n\n    subdivide() {\n        const { x, y, w, h } = this.boundary;\n        const nw = { x: x - w / 2, y: y - h / 2, w: w / 2, h: h / 2 };\n        const ne = { x: x + w / 2, y: y - h / 2, w: w / 2, h: h / 2 };\n        const sw = { x: x - w / 2, y: y + h / 2, w: w / 2, h: h / 2 };\n        const se = { x: x + w / 2, y: y + h / 2, w: w / 2, h: h / 2 };\n        this.northwest = new QuadTree(nw, this.capacity);\n        this.northeast = new QuadTree(ne, this.capacity);\n        this.southwest = new QuadTree(sw, this.capacity);\n        this.southeast = new QuadTree(se, this.capacity);\n        this.divided = true;\n    }\n\n    insert(point) {\n        if (!this._contains(this.boundary, point)) return false;\n\n        if (this.points.length < this.capacity && !this.divided) {\n            this.points.push(point);\n            return true;\n        }\n\n        if (!this.divided) this.subdivide();\n\n        return (\n            this.northwest.insert(point) ||\n            this.northeast.insert(point) ||\n            this.southwest.insert(point) ||\n            this.southeast.insert(point)\n        );\n    }\n\n    query(range, found) {\n        if (!this._intersects(this.boundary, range)) return found;\n\n        for (let p of this.points) {\n            if (this._contains(range, p)) found.push(p);\n        }\n\n        if (this.divided) {\n            this.northwest.query(range, found);\n            this.northeast.query(range, found);\n            this.southwest.query(range, found);\n            this.southeast.query(range, found);\n        }\n        return found;\n    }\n\n    _contains(rect, p) {\n        return (p.x >= rect.x - rect.w && p.x <= rect.x + rect.w &&\n            p.y >= rect.y - rect.h && p.y <= rect.y + rect.h);\n    }\n\n    _intersects(a, b) {\n        return !(b.x - b.w > a.x + a.w || b.x + b.w < a.x - a.w ||\n            b.y - b.h > a.y + a.h || b.y + b.h < a.y - a.h);\n    }\n}\n\n// --- INTERNAL JIT ENGINE (Lightweight v3.2) ---\nclass InternalJIT {\n    constructor() {\n        this.cache = new Map();\n        this.lib = {\n            map: (val, inMin, inMax, outMin, outMax) => (val - inMin) * (outMax - outMin) / (inMax - inMin) + outMin,\n            oscillate: (time, freq) => Math.sin(time * freq * Math.PI * 2) * 0.5 + 0.5,\n            lerp: (a, b, t) => a + (b - a) * t\n        };\n    }\n\n    compile(expression) {\n        if (this.cache.has(expression)) return this.cache.get(expression);\n\n        try {\n            const cleanExpr = expression.replace(/^{{|}}$/g, '').trim();\n            const parts = cleanExpr.split('|').map(p => p.trim());\n            const source = parts[0];\n            const filters = parts.slice(1);\n\n            // Sanity check for access\n            const sanitizedSource = source.replace(/[^a-zA-Z0-9_.]/g, '');\n\n            const executor = new Function('state', 'compiler', `\n                \"use strict\";\n                try {\n                    let val = state[\"${sanitizedSource}\"];\n                    if (val === undefined) return 0;\n                    ${this._buildFilterLogic(filters)}\n                    return val;\n                } catch (e) {\n                    return 0; // Fallback de Seguridad\n                }\n            `);\n\n            this.cache.set(expression, executor);\n            return executor;\n        } catch (e) {\n            console.warn(\"[ISK-WORKER] JIT Compilation error:\", e);\n            return () => 0; // Constant Fallback\n        }\n    }\n\n    _buildFilterLogic(filters) {\n        let code = '';\n        filters.forEach(f => {\n            const match = f.match(/^(\\w+)\\((.*)\\)$/);\n            if (match) {\n                const name = match[1];\n                const args = match[2];\n                code += `val = compiler.lib.${name}(val, ${args});\\n`;\n            }\n        });\n        return code;\n    }\n}\n\nconst jit = new InternalJIT();\n\n// --- STATE & BUFFERS ---\nlet iskContext = null;\nlet bufferA = null;\nlet bufferB = null;\nlet velocityBuffer = null; // [vx, vy, mass, drag] per node\nlet currentBufferIsA = true;\n\n// --- CACHES & INDEXES ---\nlet artifactIndex = new Map(); // Fast lookup ID -> Artifact Data\nlet panicMode = false;\n\n// AXIOMA: Par谩metros de F铆sica (Espejo de Spatial_Physics.js)\nconst PHYSICS_CONSTANTS = {\n    SEMANTIC_GRAVITY: 0.05,\n    REPULSION_FORCE: 800,\n    FRICTION: 0.92,\n    TIME_STEP: 1.0\n};\n\nself.onmessage = function (e) {\n    const { action, payload } = e.data;\n\n    switch (action) {\n        case 'INIT':\n            iskContext = payload;\n            const nodeCount = Object.keys(payload.laws).length;\n            const totalSize = payload.textureSize * payload.textureSize * 4;\n\n            bufferA = new Float32Array(totalSize);\n            bufferB = new Float32Array(totalSize);\n            velocityBuffer = new Float32Array(totalSize); // Reusamos estructura 4-float para vx, vy, mass, drag\n\n            // Inicializar Masas y Velocidades\n            for (const [id, law] of Object.entries(iskContext.laws)) {\n                law.id = id; // Inyectamos ID para trazabilidad interna (Task 3)\n                const offset = law.index * 4;\n                const schema = law.schemaId || 'GENERIC';\n\n                // Determinaci贸n de Masa Fenot铆pica\n                let mass = 1.0;\n                if (schema.includes('COSMOS')) mass = 5.0;\n                else if (schema.includes('FOLDER') || schema.includes('VAULT')) mass = 3.0;\n                else if (schema.includes('EMAIL')) mass = 0.8;\n\n                velocityBuffer[offset] = 0; // vx\n                velocityBuffer[offset + 1] = 0; // vy\n                velocityBuffer[offset + 2] = mass;\n                velocityBuffer[offset + 3] = 0.1 / mass; // Drag (A m谩s masa, m谩s inercia/resistencia)\n\n                // Compilaci贸n JIT\n                for (const attr in law.executors) {\n                    const expr = law.executors[attr];\n                    if (typeof expr === 'string') {\n                        law.executors[attr] = jit.compile(expr);\n                    }\n                }\n            }\n            break;\n\n        case 'UPDATE_STATE':\n            if (!iskContext) return;\n            const { state, sequenceId } = payload;\n\n            const targetBuffer = currentBufferIsA ? bufferB : bufferA;\n            const prevBuffer = currentBufferIsA ? bufferA : bufferB;\n\n            // 1. Integraci贸n de F铆sica (ISK Physics Engine v1.0)\n            applyPhysics(prevBuffer, targetBuffer, state);\n\n            // 2. Procesamiento de Expresiones (JIT Reification)\n            processExpressions(state, targetBuffer);\n\n            self.postMessage({\n                action: 'REIFICATION_RESULT',\n                results: targetBuffer,\n                sequenceId\n            }, [targetBuffer.buffer]);\n\n            // Recrear buffers tras transferencia\n            if (currentBufferIsA) bufferB = new Float32Array(targetBuffer.length);\n            else bufferA = new Float32Array(targetBuffer.length);\n\n            currentBufferIsA = !currentBufferIsA;\n            break;\n\n        case 'HFS_UPDATE':\n            if (!iskContext) return;\n            const { target_id, property, value } = payload;\n            handleHFSUpdate(target_id, property, value);\n            break;\n\n        case 'SET_PANIC_MODE':\n            panicMode = payload.enabled;\n            break;\n    }\n};\n\nfunction applyPhysics(prevBuffer, nextBuffer, state) {\n    // Tarea 3: Actualizaci贸n de ndice (Soberan铆a de Identidad)\n    const artifactList = state.phenotype.artifacts || [];\n    artifactList.forEach(art => artifactIndex.set(art.id, art));\n\n    const laws = Object.values(iskContext.laws);\n    const nodes = laws.length;\n    const idsToPurge = [];\n\n    // Tarea 1: Reconstrucci贸n del QuadTree (v10.9) - L铆mites Din谩micos\n    let minX = -1000, maxX = 1000, minY = -1000, maxY = 1000;\n    for (let i = 0; i < nodes; i++) {\n        const off = laws[i].index * 4;\n        const x = prevBuffer[off];\n        const y = prevBuffer[off + 1];\n        if (x < minX) minX = x - 100;\n        if (x > maxX) maxX = x + 100;\n        if (y < minY) minY = y - 100;\n        if (y > maxY) maxY = y + 100;\n    }\n\n    const centerX = (minX + maxX) / 2;\n    const centerY = (minY + maxY) / 2;\n    const halfWidth = (maxX - minX) / 2;\n    const halfHeight = (maxY - minY) / 2;\n\n    const qtree = new QuadTree({ x: centerX, y: centerY, w: halfWidth, h: halfHeight }, 4);\n    for (let i = 0; i < nodes; i++) {\n        const law = laws[i];\n        const off = law.index * 4;\n        const artifact = artifactIndex.get(law.id);\n        if (artifact && !artifact._isDeleted) {\n            qtree.insert({ x: prevBuffer[off], y: prevBuffer[off + 1], off });\n        }\n    }\n\n    for (let i = 0; i < nodes; i++) {\n        const law = laws[i];\n        const off = law.index * 4;\n        const artifact = artifactIndex.get(law.id);\n\n        // Ignorar objetos eliminados l贸gicamente (V10.7)\n        if (artifact?._isDeleted) {\n            nextBuffer[off + 3] = 0.0;\n            idsToPurge.push(law.id);\n            continue;\n        }\n\n        let x = prevBuffer[off];\n        let y = prevBuffer[off + 1];\n        let mass = velocityBuffer[off + 2] || 1.0;\n\n        let vx = velocityBuffer[off];\n        let vy = velocityBuffer[off + 1];\n\n        // --- 1. Atracci贸n Sem谩ntica ---\n        const dx = (state.centerX || 0) - x;\n        const dy = (state.centerY || 0) - y;\n        vx += dx * PHYSICS_CONSTANTS.SEMANTIC_GRAVITY / mass;\n        vy += dy * PHYSICS_CONSTANTS.SEMANTIC_GRAVITY / mass;\n\n        // --- 2. Repulsi贸n (OPTIMIZADA POR QUADTREE O(n log n)) ---\n        // Tarea 4: Panic Logic (Load Shedding)\n        if (!panicMode) {\n            const range = { x, y, w: 200, h: 200 };\n            const neighbors = qtree.query(range);\n\n            for (let j = 0; j < neighbors.length; j++) {\n                const neighbor = neighbors[j];\n                if (neighbor.off === off) continue;\n\n                const rdx = x - neighbor.x;\n                const rdy = y - neighbor.y;\n                const distSq = rdx * rdx + rdy * rdy + 0.1;\n\n                if (distSq < 40000) {\n                    const force = PHYSICS_CONSTANTS.REPULSION_FORCE / distSq;\n                    vx += rdx * force;\n                    vy += rdy * force;\n                }\n            }\n        }\n\n        // --- 3. Integraci贸n de Euler ---\n        vx *= PHYSICS_CONSTANTS.FRICTION;\n        vy *= PHYSICS_CONSTANTS.FRICTION;\n\n        velocityBuffer[off] = vx;\n        velocityBuffer[off + 1] = vy;\n\n        if (law._isDragging) {\n            nextBuffer[off] = x;\n            nextBuffer[off + 1] = y;\n        } else {\n            nextBuffer[off] = x + vx * PHYSICS_CONSTANTS.TIME_STEP;\n            nextBuffer[off + 1] = y + vy * PHYSICS_CONSTANTS.TIME_STEP;\n        }\n    }\n\n    // Tarea 3.1: Descarte Post-Procesamiento (Polo a Tierra)\n    idsToPurge.forEach(id => {\n        delete iskContext.laws[id];\n        artifactIndex.delete(id);\n    });\n}\n\nfunction processExpressions(state, buffer) {\n    const laws = Object.entries(iskContext.laws);\n    for (const [id, law] of laws) {\n        const offset = law.index * 4;\n        const executors = law.executors;\n        const artifact = artifactIndex.get(id);\n\n        if (artifact?._isDeleted) {\n            buffer[offset + 3] = 0.0;\n            continue;\n        }\n\n        try {\n            // AXIOMA: Optimizaci贸n por Dirty Flag (Task 3)\n            if (!artifact || artifact._isDirty || law._isDragging || state.isLoading) {\n                if (executors.x) buffer[offset] = executors.x(state, jit);\n                if (executors.y) buffer[offset + 1] = executors.y(state, jit);\n\n                buffer[offset + 2] = executors.radius ? executors.radius(state, jit) : 10;\n\n                let visibility = executors.u_visibility ? executors.u_visibility(state, jit) : 1.0;\n                if (state.isLoading) {\n                    visibility = 0.5 + Math.sin(Date.now() * 0.02) * 0.5;\n                }\n                buffer[offset + 3] = visibility;\n            }\n        } catch (err) {\n            buffer[offset + 3] = 0.0;\n        }\n    }\n}\n\nfunction handleHFSUpdate(targetId, property, value) {\n    const law = iskContext.laws[targetId];\n    if (!law) return;\n\n    const offset = law.index * 4;\n    const activeBuffer = currentBufferIsA ? bufferA : bufferB;\n\n    switch (property) {\n        case 'u_pos':\n            if (Array.isArray(value)) {\n                activeBuffer[offset] = value[0];\n                activeBuffer[offset + 1] = value[1];\n                velocityBuffer[offset] = 0; // Reset velocity on drag\n                velocityBuffer[offset + 1] = 0;\n                law._isDragging = true;\n            }\n            break;\n        case 'u_drag_end':\n            law._isDragging = false;\n            break;\n        case 'u_radius':\n            activeBuffer[offset + 2] = value;\n            break;\n        case 'u_visibility':\n            activeBuffer[offset + 3] = value ? 1.0 : 0.0;\n            break;\n    }\n\n    const partial = activeBuffer.slice();\n    self.postMessage({\n        action: 'REIFICATION_RESULT',\n        results: partial,\n        isPartial: true\n    }, [partial.buffer]);\n}\n\n\n\n"],"names":["QuadTree","boundary","capacity","x","y","w","h","nw","ne","sw","se","point","range","found","p","rect","a","b","InternalJIT","val","inMin","inMax","outMin","outMax","time","freq","t","expression","parts","source","filters","sanitizedSource","executor","e","code","f","match","name","args","jit","iskContext","bufferA","bufferB","velocityBuffer","currentBufferIsA","artifactIndex","panicMode","PHYSICS_CONSTANTS","action","payload","totalSize","id","law","offset","schema","mass","attr","expr","state","sequenceId","targetBuffer","applyPhysics","processExpressions","target_id","property","value","handleHFSUpdate","prevBuffer","nextBuffer","art","laws","nodes","idsToPurge","minX","maxX","minY","maxY","i","off","centerX","centerY","halfWidth","halfHeight","qtree","artifact","vx","vy","dx","dy","neighbors","j","neighbor","rdx","rdy","distSq","force","buffer","executors","visibility","targetId","activeBuffer","partial"],"mappings":"yBAQA,MAAMA,CAAS,CACX,YAAYC,EAAUC,EAAW,EAAG,CAChC,KAAK,SAAWD,EAChB,KAAK,SAAWC,EAChB,KAAK,OAAS,CAAA,EACd,KAAK,QAAU,EACnB,CAEA,WAAY,CACR,KAAM,CAAE,EAAAC,EAAG,EAAAC,EAAG,EAAAC,EAAG,EAAAC,CAAC,EAAK,KAAK,SACtBC,EAAK,CAAE,EAAGJ,EAAIE,EAAI,EAAG,EAAGD,EAAIE,EAAI,EAAG,EAAGD,EAAI,EAAG,EAAGC,EAAI,CAAC,EACrDE,EAAK,CAAE,EAAGL,EAAIE,EAAI,EAAG,EAAGD,EAAIE,EAAI,EAAG,EAAGD,EAAI,EAAG,EAAGC,EAAI,CAAC,EACrDG,EAAK,CAAE,EAAGN,EAAIE,EAAI,EAAG,EAAGD,EAAIE,EAAI,EAAG,EAAGD,EAAI,EAAG,EAAGC,EAAI,CAAC,EACrDI,EAAK,CAAE,EAAGP,EAAIE,EAAI,EAAG,EAAGD,EAAIE,EAAI,EAAG,EAAGD,EAAI,EAAG,EAAGC,EAAI,CAAC,EAC3D,KAAK,UAAY,IAAIN,EAASO,EAAI,KAAK,QAAQ,EAC/C,KAAK,UAAY,IAAIP,EAASQ,EAAI,KAAK,QAAQ,EAC/C,KAAK,UAAY,IAAIR,EAASS,EAAI,KAAK,QAAQ,EAC/C,KAAK,UAAY,IAAIT,EAASU,EAAI,KAAK,QAAQ,EAC/C,KAAK,QAAU,EACnB,CAEA,OAAOC,EAAO,CACV,OAAK,KAAK,UAAU,KAAK,SAAUA,CAAK,EAEpC,KAAK,OAAO,OAAS,KAAK,UAAY,CAAC,KAAK,SAC5C,KAAK,OAAO,KAAKA,CAAK,EACf,KAGN,KAAK,SAAS,KAAK,UAAS,EAG7B,KAAK,UAAU,OAAOA,CAAK,GAC3B,KAAK,UAAU,OAAOA,CAAK,GAC3B,KAAK,UAAU,OAAOA,CAAK,GAC3B,KAAK,UAAU,OAAOA,CAAK,GAbmB,EAetD,CAEA,MAAMC,EAAOC,EAAO,CAChB,GAAI,CAAC,KAAK,YAAY,KAAK,SAAUD,CAAK,EAAG,OAAOC,EAEpD,QAASC,KAAK,KAAK,OACX,KAAK,UAAUF,EAAOE,CAAC,GAAGD,EAAM,KAAKC,CAAC,EAG9C,OAAI,KAAK,UACL,KAAK,UAAU,MAAMF,EAAOC,CAAK,EACjC,KAAK,UAAU,MAAMD,EAAOC,CAAK,EACjC,KAAK,UAAU,MAAMD,EAAOC,CAAK,EACjC,KAAK,UAAU,MAAMD,EAAOC,CAAK,GAE9BA,CACX,CAEA,UAAUE,EAAMD,EAAG,CACf,OAAQA,EAAE,GAAKC,EAAK,EAAIA,EAAK,GAAKD,EAAE,GAAKC,EAAK,EAAIA,EAAK,GACnDD,EAAE,GAAKC,EAAK,EAAIA,EAAK,GAAKD,EAAE,GAAKC,EAAK,EAAIA,EAAK,CACvD,CAEA,YAAYC,EAAGC,EAAG,CACd,MAAO,EAAEA,EAAE,EAAIA,EAAE,EAAID,EAAE,EAAIA,EAAE,GAAKC,EAAE,EAAIA,EAAE,EAAID,EAAE,EAAIA,EAAE,GAClDC,EAAE,EAAIA,EAAE,EAAID,EAAE,EAAIA,EAAE,GAAKC,EAAE,EAAIA,EAAE,EAAID,EAAE,EAAIA,EAAE,EACrD,CACJ,CAGA,MAAME,CAAY,CACd,aAAc,CACV,KAAK,MAAQ,IAAI,IACjB,KAAK,IAAM,CACP,IAAK,CAACC,EAAKC,EAAOC,EAAOC,EAAQC,KAAYJ,EAAMC,IAAUG,EAASD,IAAWD,EAAQD,GAASE,EAClG,UAAW,CAACE,EAAMC,IAAS,KAAK,IAAID,EAAOC,EAAO,KAAK,GAAK,CAAC,EAAI,GAAM,GACvE,KAAM,CAACT,EAAGC,EAAGS,IAAMV,GAAKC,EAAID,GAAKU,CAC7C,CACI,CAEA,QAAQC,EAAY,CAChB,GAAI,KAAK,MAAM,IAAIA,CAAU,EAAG,OAAO,KAAK,MAAM,IAAIA,CAAU,EAEhE,GAAI,CAEA,MAAMC,EADYD,EAAW,QAAQ,WAAY,EAAE,EAAE,KAAI,EACjC,MAAM,GAAG,EAAE,IAAIb,GAAKA,EAAE,MAAM,EAC9Ce,EAASD,EAAM,CAAC,EAChBE,EAAUF,EAAM,MAAM,CAAC,EAGvBG,EAAkBF,EAAO,QAAQ,kBAAmB,EAAE,EAEtDG,EAAW,IAAI,SAAS,QAAS,WAAY;AAAA;AAAA;AAAA,uCAGxBD,CAAe;AAAA;AAAA,sBAEhC,KAAK,kBAAkBD,CAAO,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,aAKxC,EAED,YAAK,MAAM,IAAIH,EAAYK,CAAQ,EAC5BA,CACX,OAASC,EAAG,CACR,eAAQ,KAAK,sCAAuCA,CAAC,EAC9C,IAAM,CACjB,CACJ,CAEA,kBAAkBH,EAAS,CACvB,IAAII,EAAO,GACX,OAAAJ,EAAQ,QAAQK,GAAK,CACjB,MAAMC,EAAQD,EAAE,MAAM,iBAAiB,EACvC,GAAIC,EAAO,CACP,MAAMC,EAAOD,EAAM,CAAC,EACdE,EAAOF,EAAM,CAAC,EACpBF,GAAQ,sBAAsBG,CAAI,SAASC,CAAI;AAAA,CACnD,CACJ,CAAC,EACMJ,CACX,CACJ,CAEA,MAAMK,EAAM,IAAIrB,EAGhB,IAAIsB,EAAa,KACbC,EAAU,KACVC,EAAU,KACVC,EAAiB,KACjBC,EAAmB,GAGnBC,EAAgB,IAAI,IACpBC,EAAY,GAGhB,MAAMC,EAAoB,CACtB,iBAAkB,IAClB,gBAAiB,IACjB,SAAU,IACV,UAAW,CACf,EAEA,KAAK,UAAY,SAAUd,EAAG,CAC1B,KAAM,CAAE,OAAAe,EAAQ,QAAAC,CAAO,EAAKhB,EAAE,KAE9B,OAAQe,EAAM,CACV,IAAK,OACDR,EAAaS,EACK,OAAO,KAAKA,EAAQ,IAAI,EAAE,OAC5C,MAAMC,EAAYD,EAAQ,YAAcA,EAAQ,YAAc,EAE9DR,EAAU,IAAI,aAAaS,CAAS,EACpCR,EAAU,IAAI,aAAaQ,CAAS,EACpCP,EAAiB,IAAI,aAAaO,CAAS,EAG3C,SAAW,CAACC,EAAIC,CAAG,IAAK,OAAO,QAAQZ,EAAW,IAAI,EAAG,CACrDY,EAAI,GAAKD,EACT,MAAME,EAASD,EAAI,MAAQ,EACrBE,EAASF,EAAI,UAAY,UAG/B,IAAIG,EAAO,EACPD,EAAO,SAAS,QAAQ,EAAGC,EAAO,EAC7BD,EAAO,SAAS,QAAQ,GAAKA,EAAO,SAAS,OAAO,EAAGC,EAAO,EAC9DD,EAAO,SAAS,OAAO,IAAGC,EAAO,IAE1CZ,EAAeU,CAAM,EAAI,EACzBV,EAAeU,EAAS,CAAC,EAAI,EAC7BV,EAAeU,EAAS,CAAC,EAAIE,EAC7BZ,EAAeU,EAAS,CAAC,EAAI,GAAME,EAGnC,UAAWC,KAAQJ,EAAI,UAAW,CAC9B,MAAMK,EAAOL,EAAI,UAAUI,CAAI,EAC3B,OAAOC,GAAS,WAChBL,EAAI,UAAUI,CAAI,EAAIjB,EAAI,QAAQkB,CAAI,EAE9C,CACJ,CACA,MAEJ,IAAK,eACD,GAAI,CAACjB,EAAY,OACjB,KAAM,CAAE,MAAAkB,EAAO,WAAAC,CAAU,EAAKV,EAExBW,EAAehB,EAAmBF,EAAUD,EAIlDoB,EAHmBjB,EAAmBH,EAAUC,EAGvBkB,EAAcF,CAAK,EAG5CI,EAAmBJ,EAAOE,CAAY,EAEtC,KAAK,YAAY,CACb,OAAQ,qBACR,QAASA,EACT,WAAAD,CAChB,EAAe,CAACC,EAAa,MAAM,CAAC,EAGpBhB,EAAkBF,EAAU,IAAI,aAAakB,EAAa,MAAM,EAC/DnB,EAAU,IAAI,aAAamB,EAAa,MAAM,EAEnDhB,EAAmB,CAACA,EACpB,MAEJ,IAAK,aACD,GAAI,CAACJ,EAAY,OACjB,KAAM,CAAE,UAAAuB,EAAW,SAAAC,EAAU,MAAAC,CAAK,EAAKhB,EACvCiB,EAAgBH,EAAWC,EAAUC,CAAK,EAC1C,MAEJ,IAAK,iBACDnB,EAAYG,EAAQ,QACpB,KACZ,CACA,EAEA,SAASY,EAAaM,EAAYC,EAAYV,EAAO,EAE5BA,EAAM,UAAU,WAAa,CAAA,GACrC,QAAQW,GAAOxB,EAAc,IAAIwB,EAAI,GAAIA,CAAG,CAAC,EAE1D,MAAMC,EAAO,OAAO,OAAO9B,EAAW,IAAI,EACpC+B,EAAQD,EAAK,OACbE,EAAa,CAAA,EAGnB,IAAIC,EAAO,KAAOC,EAAO,IAAMC,EAAO,KAAOC,EAAO,IACpD,QAASC,EAAI,EAAGA,EAAIN,EAAOM,IAAK,CAC5B,MAAMC,EAAMR,EAAKO,CAAC,EAAE,MAAQ,EACtB1E,EAAIgE,EAAWW,CAAG,EAClB1E,EAAI+D,EAAWW,EAAM,CAAC,EACxB3E,EAAIsE,IAAMA,EAAOtE,EAAI,KACrBA,EAAIuE,IAAMA,EAAOvE,EAAI,KACrBC,EAAIuE,IAAMA,EAAOvE,EAAI,KACrBA,EAAIwE,IAAMA,EAAOxE,EAAI,IAC7B,CAEA,MAAM2E,GAAWN,EAAOC,GAAQ,EAC1BM,GAAWL,EAAOC,GAAQ,EAC1BK,GAAaP,EAAOD,GAAQ,EAC5BS,GAAcN,EAAOD,GAAQ,EAE7BQ,EAAQ,IAAInF,EAAS,CAAE,EAAG+E,EAAS,EAAGC,EAAS,EAAGC,EAAW,EAAGC,CAAU,EAAI,CAAC,EACrF,QAASL,EAAI,EAAGA,EAAIN,EAAOM,IAAK,CAC5B,MAAMzB,EAAMkB,EAAKO,CAAC,EACZC,EAAM1B,EAAI,MAAQ,EAClBgC,EAAWvC,EAAc,IAAIO,EAAI,EAAE,EACrCgC,GAAY,CAACA,EAAS,YACtBD,EAAM,OAAO,CAAE,EAAGhB,EAAWW,CAAG,EAAG,EAAGX,EAAWW,EAAM,CAAC,EAAG,IAAAA,CAAG,CAAE,CAExE,CAEA,QAASD,EAAI,EAAGA,EAAIN,EAAOM,IAAK,CAC5B,MAAMzB,EAAMkB,EAAKO,CAAC,EACZC,EAAM1B,EAAI,MAAQ,EAClBgC,EAAWvC,EAAc,IAAIO,EAAI,EAAE,EAGzC,GAAIgC,GAAA,MAAAA,EAAU,WAAY,CACtBhB,EAAWU,EAAM,CAAC,EAAI,EACtBN,EAAW,KAAKpB,EAAI,EAAE,EACtB,QACJ,CAEA,IAAIjD,EAAIgE,EAAWW,CAAG,EAClB1E,EAAI+D,EAAWW,EAAM,CAAC,EACtBvB,EAAOZ,EAAemC,EAAM,CAAC,GAAK,EAElCO,EAAK1C,EAAemC,CAAG,EACvBQ,EAAK3C,EAAemC,EAAM,CAAC,EAG/B,MAAMS,GAAM7B,EAAM,SAAW,GAAKvD,EAC5BqF,GAAM9B,EAAM,SAAW,GAAKtD,EAMlC,GALAiF,GAAME,EAAKxC,EAAkB,iBAAmBQ,EAChD+B,GAAME,EAAKzC,EAAkB,iBAAmBQ,EAI5C,CAACT,EAAW,CACZ,MAAMlC,EAAQ,CAAE,EAAAT,EAAG,EAAAC,EAAG,EAAG,IAAK,EAAG,GAAG,EAC9BqF,EAAYN,EAAM,MAAMvE,CAAK,EAEnC,QAAS8E,EAAI,EAAGA,EAAID,EAAU,OAAQC,IAAK,CACvC,MAAMC,EAAWF,EAAUC,CAAC,EAC5B,GAAIC,EAAS,MAAQb,EAAK,SAE1B,MAAMc,EAAMzF,EAAIwF,EAAS,EACnBE,EAAMzF,EAAIuF,EAAS,EACnBG,EAASF,EAAMA,EAAMC,EAAMA,EAAM,GAEvC,GAAIC,EAAS,IAAO,CAChB,MAAMC,EAAQhD,EAAkB,gBAAkB+C,EAClDT,GAAMO,EAAMG,EACZT,GAAMO,EAAME,CAChB,CACJ,CACJ,CAGAV,GAAMtC,EAAkB,SACxBuC,GAAMvC,EAAkB,SAExBJ,EAAemC,CAAG,EAAIO,EACtB1C,EAAemC,EAAM,CAAC,EAAIQ,EAEtBlC,EAAI,aACJgB,EAAWU,CAAG,EAAI3E,EAClBiE,EAAWU,EAAM,CAAC,EAAI1E,IAEtBgE,EAAWU,CAAG,EAAI3E,EAAIkF,EAAKtC,EAAkB,UAC7CqB,EAAWU,EAAM,CAAC,EAAI1E,EAAIkF,EAAKvC,EAAkB,UAEzD,CAGAyB,EAAW,QAAQrB,GAAM,CACrB,OAAOX,EAAW,KAAKW,CAAE,EACzBN,EAAc,OAAOM,CAAE,CAC3B,CAAC,CACL,CAEA,SAASW,EAAmBJ,EAAOsC,EAAQ,CACvC,MAAM1B,EAAO,OAAO,QAAQ9B,EAAW,IAAI,EAC3C,SAAW,CAACW,EAAIC,CAAG,IAAKkB,EAAM,CAC1B,MAAMjB,EAASD,EAAI,MAAQ,EACrB6C,EAAY7C,EAAI,UAChBgC,EAAWvC,EAAc,IAAIM,CAAE,EAErC,GAAIiC,GAAA,MAAAA,EAAU,WAAY,CACtBY,EAAO3C,EAAS,CAAC,EAAI,EACrB,QACJ,CAEA,GAAI,CAEA,GAAI,CAAC+B,GAAYA,EAAS,UAAYhC,EAAI,aAAeM,EAAM,UAAW,CAClEuC,EAAU,IAAGD,EAAO3C,CAAM,EAAI4C,EAAU,EAAEvC,EAAOnB,CAAG,GACpD0D,EAAU,IAAGD,EAAO3C,EAAS,CAAC,EAAI4C,EAAU,EAAEvC,EAAOnB,CAAG,GAE5DyD,EAAO3C,EAAS,CAAC,EAAI4C,EAAU,OAASA,EAAU,OAAOvC,EAAOnB,CAAG,EAAI,GAEvE,IAAI2D,EAAaD,EAAU,aAAeA,EAAU,aAAavC,EAAOnB,CAAG,EAAI,EAC3EmB,EAAM,YACNwC,EAAa,GAAM,KAAK,IAAI,KAAK,IAAG,EAAK,GAAI,EAAI,IAErDF,EAAO3C,EAAS,CAAC,EAAI6C,CACzB,CACJ,MAAc,CACVF,EAAO3C,EAAS,CAAC,EAAI,CACzB,CACJ,CACJ,CAEA,SAASa,EAAgBiC,EAAUnC,EAAUC,EAAO,CAChD,MAAMb,EAAMZ,EAAW,KAAK2D,CAAQ,EACpC,GAAI,CAAC/C,EAAK,OAEV,MAAMC,EAASD,EAAI,MAAQ,EACrBgD,EAAexD,EAAmBH,EAAUC,EAElD,OAAQsB,EAAQ,CACZ,IAAK,QACG,MAAM,QAAQC,CAAK,IACnBmC,EAAa/C,CAAM,EAAIY,EAAM,CAAC,EAC9BmC,EAAa/C,EAAS,CAAC,EAAIY,EAAM,CAAC,EAClCtB,EAAeU,CAAM,EAAI,EACzBV,EAAeU,EAAS,CAAC,EAAI,EAC7BD,EAAI,YAAc,IAEtB,MACJ,IAAK,aACDA,EAAI,YAAc,GAClB,MACJ,IAAK,WACDgD,EAAa/C,EAAS,CAAC,EAAIY,EAC3B,MACJ,IAAK,eACDmC,EAAa/C,EAAS,CAAC,EAAIY,EAAQ,EAAM,EACzC,KACZ,CAEI,MAAMoC,EAAUD,EAAa,MAAK,EAClC,KAAK,YAAY,CACb,OAAQ,qBACR,QAASC,EACT,UAAW,EACnB,EAAO,CAACA,EAAQ,MAAM,CAAC,CACvB"}