üèõÔ∏è ESPECIFICACI√ìN T√âCNICA: ISK-USSP (v1.0)
ID: ISK-Unified-State-Synchronization-Protocol
Alcance: Sincronizaci√≥n de estado reactivo entre el Hilo Principal (UI), el Spatial Worker (C√°lculo) y el VectorAdapter (Persistencia).
1. Restricciones de Arquitectura (System Constraints)
Para garantizar la estabilidad del sistema bajo cargas de 10k+ entidades, el protocolo impone las siguientes restricciones t√©cnicas:
Determinismo de Estado: Ante un mismo payload y un mismo state_id, el resultado en el motor de renderizado debe ser id√©ntico.
Ejecuci√≥n No-Bloqueante (Non-Blocking): El procesamiento de mensajes de persistencia no debe exceder el presupuesto de frame (16.6ms) del hilo principal.
Validaci√≥n de Tipos en el Borde (Edge Type Safety): El Bridge debe validar el ValueType contra el esquema del SpatialLaw antes de la propagaci√≥n al Worker.
Sincronizaci√≥n Delta (Differential Sync): Solo se transmiten los atributos modificados. Se proh√≠be el env√≠o de objetos de estado completos para minimizar la presi√≥n sobre el Garbage Collector.
2. Clasificaci√≥n de Canales de Datos (Data Channels)
El protocolo segmenta el tr√°fico en tres canales basados en su presupuesto de latencia (Latency Budget):
Canal 0: High-Frequency Sync (HFS)
Frecuencia: 60Hz.
Latencia: < 16ms.
Uso: Actualizaci√≥n de atributos visuales (transform, opacity, shaders).
Persistencia: Vol√°til (In-memory only).
Transporte: postMessage con Transferable Objects (TypedArrays).
Canal 1: Asynchronous Persistence (ASP)
Frecuencia: Bajo demanda (Event-driven).
Latencia: < 500ms.
Uso: Guardado de cambios estructurales en el .layout.json.
Mec√°nica: Debounced (300ms) para evitar saturaci√≥n de I/O en el Core.
Canal 2: System Control (SYS)
Frecuencia: Baja.
Uso: Errores de validaci√≥n, violaciones de esquema, latidos de integridad (Heartbeats).
3. Estructura del Paquete (Data Schema)
La interfaz de mensaje se define mediante la siguiente interfaz TypeScript/JSON:
code
TypeScript
interface ISK_USSP_Packet {
  version: "1.0";
  header: {
    msg_id: string;        // UUID v4
    timestamp: number;     // Unix Epoch ms
    source: 0 | 1 | 2;     // 0: UI, 1: Worker, 2: Core
    priority: 0 | 1 | 2;   // 0: Critical, 1: Normal, 2: Low
  };
  payload: {
    action: "SET" | "BIND" | "DELETE" | "INIT";
    target_id: string;     // Entity UUID
    property: string;      // Atributo espec√≠fico (ej: "u_bloom")
    value: any;            // Valor del atributo
    value_type: "f32" | "i32" | "v3" | "str" | "bool";
  };
  integrity: {
    persistence: 0 | 1 | 2; // 0: Volatile, 1: Deferred, 2: Immediate
    checksum?: string;      // Opcional para validaci√≥n de integridad
  };
}
4. Pipeline de Procesamiento de Mensajes
Ingesta: El Dispatcher recibe la interacci√≥n del usuario.
Validaci√≥n: El TypeGuard verifica que value_type coincida con la definici√≥n en SpatialLaw.
Propagaci√≥n Visual: Si persistence es 0 o 1, el mensaje se env√≠a inmediatamente al SpatialWorker v√≠a postMessage.
Buffer de Persistencia: Si persistence es 1 o 2, el mensaje se encola en el PersistenceManager.
Commit: El PersistenceManager ejecuta el fetch hacia el VectorAdapter del Core una vez cumplido el tiempo de debounce.
5. Gesti√≥n de Errores y Fallback
Type Mismatch: El protocolo descarta el mensaje y emite un c√≥digo de error ERR_TYPE_VIOLATION al canal SYS.
Persistence Timeout: Si el Core no confirma el recibo en < 5000ms, el mensaje se mueve a un RetryQueue en IndexedDB.
Circular Dependency: El DependencyGraph del Bridge analiza los mensajes BIND para detectar bucles infinitos antes de la ejecuci√≥n.
6. Componentes de Software (M√≥dulos JS)
USSP_Dispatcher.js: Punto de entrada √∫nico para la emisi√≥n de mensajes.
USSP_Bridge.js: L√≥gica de enrutamiento y validaci√≥n de tipos.
USSP_Persistence.js: Gestor de sincronizaci√≥n as√≠ncrona con el Core.
Veredicto T√©cnico: Este documento elimina la narrativa y se centra en la interoperabilidad de datos. Es un protocolo de sincronizaci√≥n de estado est√°ndar que cualquier desarrollador senior puede implementar y testear mediante pruebas unitarias de carga y latencia.